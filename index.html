<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <title>Where Can I Watch This?</title>
  <link rel="stylesheet" type="text/css" href="css/style.css">
  <link rel="stylesheet" type="text/css" href="css/input.css">
  <link rel="stylesheet" type="text/css" href="css/modal.css">
  <link rel='stylesheet' href='https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css'>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css'>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

</head>

<script>

  $(document).ready(function () {
    $("input").keypress(function () {
      var keycode = (event.keyCode ? event.keyCode : event.which);
      var data = [];

      if (keycode == '13') {

        var txt = $('input[name="search"]').val();
        $.ajax({
          url: "https://apis.justwatch.com/content/titles/en_IN/popular",
          type: "POST",
          data: JSON.stringify(
            {
              "page_size": 10,
              "page": 1,
              "query": txt,
              "content_types": ["show", "movie"]
            }
          ),
          contentType: "application/json; charset=utf-8",
          dataType: "json",
          success: function (result) {
            data = result.items
            PopulateDropDownList(data);
          }
        });
      }
    });
  });
</script>

<script>
  function PopulateDropDownList(data) {
    var ddlCustomers = $("#dataList");
    ddlCustomers.empty();
    $(data).each(function () {
      var option = $("<li />");
      var poster = this.poster;
      var posterURL = poster.replace("{profile}", "s332>");
      option.html("<img class=thumbnail src=" + "https://images.justwatch.com" + posterURL + "<p>" + this.title + " <br>" + "(" + this.original_release_year + ")" + "</p>");
      option.attr('data-id', this.id);
      option.attr('data-object', this.object_type);
      ddlCustomers.append(option);
    });
  }
</script>


</head>

<body onload="javascript:fetchProviders()">

  <p class="headline">Where can I watch this?</p>
  <ul id="growing-search-container">
    <li>
      <div class="growing-search">
        <div class="input">
          <input id="input" type="text" name="search" placeholder="TV Show / Movie" list="dataList">
        </div>
      </div>
    </li>
  </ul>

  <ul id="dataList" class="flex" style="list-style-type:none;"></ul>
  <!-- The Modal -->
  <div id="myModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
      <p><span class="close">&times;</span></p>
      <div id="image-rating">
        <div class="crossfade"></div>
        <div id="movie-rating">
          <div class="imdb"></div>
          <div class="rt"></div>
        </div>
      </div>

      <div class="modal-header">
        <h2 class="modal-title">Modal Header</h2>
      </div>
      <div class="modal-body">
        <p class="description">Some text in the Modal Body</p>
      </div>

      <div class="switch-container">
        <div class="switch-toggle switch-3 switch-candy">

          <input id="free" name="state-d" type="radio" onclick="filterProvider(this.id)">
          <label for="free">Free</label>

          <input id="flatrate" name="state-d" type="radio" onclick="filterProvider(this.id)">
          <label for="flatrate">Streams</label>

          <input id="rent" name="state-d" type="radio" onclick="filterProvider(this.id)">
          <label for="rent">Rent</label>

          <input id="buy" name="state-d" type="radio" onclick="filterProvider(this.id)">
          <label for="buy">Buy</label>
        </div>
      </div>



      <div class="modal-providers">

        <ul id="provider-list">

        </ul>
      </div>

      <div class="modal-footer">
        <h3>Modal Footer</h3>
      </div>


      <div class="video-gallery">
        <ul id="video" class="video-flex">
          <!-- <iframe style="width: 33%;" src="https://www.youtube.com/embed/tgbNymZ7vqY">
          </iframe> 
          <iframe style="width: 33%" src="https://www.youtube.com/embed/tgbNymZ7vqY">
          </iframe> 
          <iframe style="width: 33%" src="https://www.youtube.com/embed/tgbNymZ7vqY"></iframe>  -->
        </ul>
      </div>

    </div>
  </div>

</body>

<script type="text/javascript">

  var providers = "";
  var offerObject = "";
  var objMatches = "";

  $(document).ready(function () {
    $("#dataList").on("click", "li", function () {

      var object = $(this).attr("data-object");
      var id = $(this).attr("data-id");

      fetchMovieDetails(object + "/" + id);
    });

  });


  var HttpClient = function () {
    this.get = function (aUrl, aCallback) {
      var anHttpRequest = new XMLHttpRequest();
      anHttpRequest.onreadystatechange = function () {
        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
          aCallback(anHttpRequest.responseText);
      }

      anHttpRequest.open("GET", aUrl, true);
      anHttpRequest.send(null);
    }
  }


  function fetchProviders() {
    var client = new HttpClient();
    client.get("https://apis.justwatch.com/content/providers/locale/en_IN", function (response) {
      var jsonObj = JSON.parse(response);
      providers = jsonObj;
    });
  }


  function fetchMovieDetails(id) {
    var client = new HttpClient();
    client.get("https://apis.justwatch.com/content/titles/" + id + "/locale/en_IN", function (response) {
      var jsonObj = JSON.parse(response);
      showModal(jsonObj);
    });
  }

  function showModal(details) {

    modal.style.display = "block";
    document.querySelector(".modal-title").innerHTML = details.title;
    document.querySelector(".description").innerHTML = details.short_description;
    var img = "";
    for (var i = 0; i < 3; i++) {
      if (typeof details.backdrops[i] !== "undefined") {
        var imageURL = details.backdrops[i].backdrop_url;
        img += "<img class=\"backdrop\" src=" + "https://images.justwatch.com" + imageURL.replace("{profile}", "s1920>")
      }
    }

    document.querySelector(".crossfade").innerHTML = "<div class=\"gallery\">" + img + "</div>";

    for (var i = 0; i < details.scoring.length; i++) {
      var detail = details.scoring[i];

      if (detail.provider_type === "imdb:score") {
        document.querySelector(".imdb").innerHTML = "IMDb" + "<br>" + "<span class= score-details>" + detail.value + "</span>";
      } else {
        document.querySelector(".imdb").innerHTML = "";
      }

      if (detail.provider_type === "tomato:meter") {
        document.querySelector(".rt").innerHTML = "Rotten Tomatoes" + "<br>" + "<span class= score-details>" + detail.value + "</span>";
      } else {
        document.querySelector(".rt").innerHTML = "";
      }

    }

    // if (details.clips) {
    //   var clip = "";
    //   //for (var i = 0; i < details.clips.length; i++) {
    //     var youtuber = details.clips[0];
    //     clip = "<li class=video-frame><iframe src=https://www.youtube.com/embed/" + youtuber.external_id + " allowfullscreen></iframe></li>";
    //  // }
    //   document.querySelector("#video").innerHTML = clip;

    // } else {
    //   document.querySelector("#video").innerHTML = "";
    // }

    var channels = ""
    var img = ""
    if (details.hasOwnProperty('offers')) {
      for (var i = 0; i < details.offers.length; i++) {
        if (typeof details.offers[i] !== "undefined") {
          var offer = details.offers[i];
          objMatches = findObjectByKey(providers, 'id', offer.provider_id);
          if (objMatches !== null) {
            if (objMatches.icon_url !== null) {
              details.offers[i].iconURL = "https://images.justwatch.com" + objMatches.icon_url.replace("{profile}", "s100");

              if (objMatches.clear_name !== "undefined") {
                details.offers[i].clearName = objMatches.clear_name;
              }
              // channels += "<img class=\"channel-img\" src=" + "https://images.justwatch.com" + objMatches.icon_url.replace("{profile}", "s100>")
            }
          }
        }
      }
      offerObject = details.offers;
      //  document.querySelector("#provider-list").innerHTML = channels;
    } else {
      // document.querySelector("#provider-list").innerHTML = "";
    }

  }


  function filterProvider(type) {
    var images = "";

    for (var i = 0; i < offerObject.length; i++) {
      var offerObj = offerObject[i];
      if (offerObj.monetization_type === type) {
        if (offerObj.iconURL !== "undefined") {
          images += "<li class=provider-icon> <img class=\"channel-img\" src=" + offerObj.iconURL + "></li>";
        } else {
          images = "";
        }
      } else {
        document.querySelector("#provider-list").innerHTML = "";
      }
      console.log(offerObj);
    }
    document.querySelector("#provider-list").innerHTML = images;
  }

  function findObjectByKey(array, key, value) {
    for (var i = 0; i < array.length; i++) {
      if (array[i][key] === value) {
        return array[i];
      }
    }
    return null;
  }



  // Get the modal
  var modal = document.getElementById("myModal");

  // Get the button that opens the modal
  var btn = document.getElementById("myBtn");

  // Get the <span> element that closes the modal
  var span = document.getElementsByClassName("close")[0];

  // When the user clicks on <span> (x), close the modal
  span.onclick = function () {
    modal.style.display = "none";
  }

  // When the user clicks anywhere outside of the modal, close it
  window.onclick = function (event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }

</script>

</html>